<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ü§ñ Andy ‚Äî Auto-am√©lioration</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #0d1117; color: #f5f5f5; margin: 0; padding: 0; }
    header { background: linear-gradient(90deg, #ff8800, #ffcc00); color: #000; text-align: center; padding: 1rem; font-weight: bold; }
    main { padding: 2rem; max-width: 1000px; margin: auto; }
    textarea { width: 100%; height: 120px; background: #1a1d29; color: #f5f5f5; border: 1px solid #444; border-radius: 8px; padding: .5rem; }
    button { margin: .3rem; padding: .6rem 1.2rem; background: #ff8800; border: none; color: #000; border-radius: 6px; cursor: pointer; font-weight: bold; }
    button:hover { background: #ffaa33; }
    pre { background: #1a1d29; padding: 1rem; border-radius: 8px; color: #00e676; white-space: pre-wrap; overflow-x: auto; }
    #status { margin-top: 1rem; color: #aaa; font-style: italic; }
  </style>
</head>
<body>
  <header>üõ†Ô∏è Andy ‚Äî Auto-am√©lioration & V√©rification</header>
  <main>
    <h2>Objectif</h2>
    <textarea id="objective" placeholder="Ex : Am√©liorer la recherche, acc√©l√©rer l‚Äôanalyse, optimiser la m√©moire..."></textarea>
    <div>
      <button onclick="gen()">üöÄ G√©n√©rer + V√©rifier</button>
      <button onclick="applyPatch()">üíæ Valider et appliquer</button>
    </div>

    <h3>üí° Proposition d‚ÄôAndy :</h3>
    <pre id="out">Aucune proposition pour le moment...</pre>
    <div id="status"></div>
  </main>

  <script>
    async function gen(){
      const obj = document.getElementById('objective').value.trim();
      const status = document.getElementById('status');
      const out = document.getElementById('out');
      if (!obj) return alert("‚ö†Ô∏è Indique un objectif.");

      status.textContent = "üß† G√©n√©ration et v√©rification...";
      try {
        const res = await fetch(`/self_propose?objective=${encodeURIComponent(obj)}`);
        const data = await res.json();
        const patch = data.patch || data.detail || "";
        out.textContent = patch;

        await fetch("/log_code", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({code: patch, source: "self_review", meta: {objective: obj}})
        });

        status.textContent = "‚úÖ Proposition g√©n√©r√©e et enregistr√©e.";
      } catch (e) {
        status.textContent = "‚ùå Erreur : " + e.message;
      }
    }

    async function applyPatch(){
      const full = document.getElementById('out').textContent;
      const m = full.match(/```(?:python)?\s*\n([\s\S]*?)```/m);
      const code = m ? m[1] : full;

      const file = prompt("Nom du fichier √† modifier (ex: app/services/search.py)");
      if (!file) return alert("Fichier non sp√©cifi√©");

      const resp = await fetch("/apply_patch", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({file_path: file, new_code: code})
      });
      const data = await resp.json();
      alert("‚úÖ " + data.detail);
    }
  </script>
</body>
</html>
